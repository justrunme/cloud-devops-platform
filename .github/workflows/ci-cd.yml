name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate-and-format:
    name: Validate and Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0 # Or a version that suits your needs

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        working-directory: ./terraform

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ./terraform

  security-scans:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: validate-and-format

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0 # Or a version that suits your needs

      - name: Terraform Init
        id: init_security
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Apply (Create Kind Cluster and Deploy Apps)
        id: apply_security
        run: terraform apply -auto-approve
        working-directory: ./terraform
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig

      - name: Install Trivy
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.52.2/trivy_0.52.2_Linux-64bit.deb
          sudo dpkg -i trivy_0.52.2_Linux-64bit.deb

      - name: Run Trivy Vulnerability Scan in Cluster
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig
        run: trivy k8s --report summary cluster

      - name: Run kube-bench
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig
        run: |
          kubectl apply -f security/kube-bench-config.yaml
          kubectl wait --for=condition=complete job/kube-bench --timeout=5m
          kubectl logs job/kube-bench > kube-bench-results.txt
          cat kube-bench-results.txt

      - name: Install Kubescape
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig
        run: | 
          curl -s https://raw.githubusercontent.com/kubescape/kubescape/master/install.sh | /bin/bash

      - name: Run Kubescape Scan
        env:
          KUBECONFIG: ${{ github.workspace }}/terraform/kubeconfig
        run: |
          kubescape scan --kubecontext cloud-devops-platform --format pretty --output SECURITY-REPORT.md
          cat SECURITY-REPORT.md
